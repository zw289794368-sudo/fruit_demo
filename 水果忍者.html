<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fruit Ninja: Challenge Mode</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            /* Default wood texture gradient */
            background: radial-gradient(circle, #4a3b32 0%, #2d241e 100%);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        /* RTL Support for Arabic */
        html[dir="rtl"] body {
            font-family: 'Segoe UI', Tahoma, 'Arial', sans-serif; /* Arabic fonts */
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
            background-color: transparent;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            z-index: 10;
        }

        .hud-top {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            width: 100%;
            box-sizing: border-box;
            background: linear-gradient(to bottom, rgba(0,0,0,0.6), transparent);
        }

        /* RTL specific adjustments for HUD are handled automatically by flexbox + dir="rtl" */

        .hud-column {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .level-badge {
            background: #ff00de;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(255, 0, 222, 0.5);
            margin-bottom: 5px;
            display: inline-block;
        }

        .score-box { font-size: 24px; font-weight: bold; }
        .score-box span { color: #ffd700; }
        
        .target-box { font-size: 14px; color: #aaa; }

        .timer-box {
            font-size: 32px;
            font-weight: bold;
            color: #fff;
            background: rgba(0,0,0,0.3);
            padding: 5px 15px;
            border-radius: 10px;
            border: 2px solid rgba(255,255,255,0.2);
        }
        .timer-box.warning { color: #ff4444; animation: pulse 1s infinite; }

        .lives-box { font-size: 24px; letter-spacing: 5px; }

        .screen-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            transition: opacity 0.3s;
            z-index: 20;
            backdrop-filter: blur(5px);
        }

        h1 {
            color: white;
            font-size: 42px;
            margin: 0 0 10px 0;
            text-shadow: 0 0 10px #ff00de, 0 0 20px #ff00de;
            text-align: center;
        }

        h2 {
            color: #ffd700;
            font-size: 28px;
            margin: 0 0 20px 0;
        }

        p {
            color: #ddd;
            font-size: 18px;
            margin-bottom: 30px;
            text-align: center;
            max-width: 80%;
            line-height: 1.5;
        }

        .btn {
            background: linear-gradient(45deg, #ff9a9e 0%, #fad0c4 99%, #fad0c4 100%);
            border: none;
            padding: 15px 50px;
            font-size: 24px;
            border-radius: 50px;
            cursor: pointer;
            color: #fff;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
            transition: transform 0.1s;
            text-transform: uppercase;
            outline: none;
            margin-top: 10px;
        }
        .btn:active { transform: scale(0.95); }

        .hidden {
            display: none !important;
            opacity: 0;
            pointer-events: none;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .shake-effect { animation: shake 0.5s; }

        .mission-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
            min-width: 280px;
        }
        .mission-item {
            color: #fff;
            font-size: 18px;
            margin: 5px 0;
        }
        .mission-val { color: #ffd700; font-weight: bold; }

        .tutorial-box {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .t-item {
            background: rgba(0,0,0,0.5);
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #444;
            color: #ddd;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .t-icon { font-size: 24px; }

        /* Language Switcher */
        .lang-switch {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            gap: 10px;
        }
        .lang-btn {
            background: rgba(0,0,0,0.5);
            border: 1px solid white;
            color: white;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
        }
        .lang-btn.active {
            background: #ff00de;
            border-color: #ff00de;
        }
        
        /* Adjust lang switch position for RTL */
        html[dir="rtl"] .lang-switch {
            right: auto;
            left: 20px;
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div class="hud-top">
            <div class="hud-column">
                <div class="level-badge" id="level-badge">Level 1</div>
                <div class="score-box"><span data-t="scoreLabel">Score</span>: <span id="score">0</span></div>
                <div class="target-box"><span data-t="targetLabel">Target</span>: <span id="target-score">100</span></div>
            </div>
            
            <div class="timer-box" id="timer">60</div>

            <div class="hud-column" style="align-items: flex-end;">
                <div class="lives-box" id="lives">â¤ï¸â¤ï¸â¤ï¸</div>
            </div>
        </div>
    </div>

    <!-- Main Menu -->
    <div id="menu-screen" class="screen-overlay">
        <!-- Language Switcher -->
        <div class="lang-switch">
            <button class="lang-btn active" onclick="setLang('en')">English</button>
            <button class="lang-btn" onclick="setLang('ar')">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
        </div>

        <h1 data-t="gameTitle">ğŸ‰ Fruit Ninja ğŸ¥</h1>
        <h2 data-t="gameSubtitle">Challenge Mode</h2>
        
        <div class="tutorial-box">
            <div class="t-item"><span class="t-icon">ğŸ</span> <span data-t="tutSlice">Slice fruits</span></div>
            <div class="t-item"><span class="t-icon">ğŸ’£</span> <span data-t="tutBomb">Bombs hurt</span></div>
            <div class="t-item"><span class="t-icon">â³</span> <span data-t="tutTime">Beat the timer</span></div>
        </div>

        <div class="mission-info">
            <p style="margin:0; font-size: 20px; color: #fff;" data-t="readyMsg">Ready for the challenge?</p>
            <p style="margin:5px 0 0 0; font-size: 14px; color: #aaa;" data-t="startMsg">Start from Level 1</p>
        </div>
        <button id="start-btn" class="btn" data-t="btnStart">Start Game</button>
    </div>

    <!-- Level Clear Screen -->
    <div id="level-clear-screen" class="screen-overlay hidden">
        <h1 style="color:#4dff4d; text-shadow:0 0 20px #4dff4d;" data-t="levelCleared">ğŸ‰ Level Cleared!</h1>
        <div class="mission-info">
            <div class="mission-item"><span data-t="nextLevel">Next Level</span>: <span class="mission-val" id="next-level-num">2</span></div>
            <div class="mission-item"><span data-t="targetScore">Target Score</span>: <span class="mission-val" id="next-target">150</span></div>
            <div class="mission-item"><span data-t="timeLimit">Time Limit</span>: <span class="mission-val" id="next-time">60s</span></div>
        </div>
        <button id="next-level-btn" class="btn" data-t="btnNext">Next Level</button>
    </div>

    <!-- Game Over Screen -->
    <div id="game-over-screen" class="screen-overlay hidden">
        <h1 style="color:#ff4444;" data-t="gameOver">Game Over</h1>
        <p><span data-t="reachedLevel">You reached</span> <span id="final-level" style="color:#fff; font-weight:bold;">Level 1</span></p>
        <p><span data-t="levelScore">Level Score</span>: <span id="final-score" style="color:#ffd700; font-weight:bold;">0</span></p>
        <button id="restart-btn" class="btn" data-t="btnTryAgain">Try Again</button>
        <button id="home-btn" class="btn" data-t="btnHome" style="margin-top: 15px; background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);">Home</button>
    </div>

    <!-- Victory Screen -->
    <div id="victory-screen" class="screen-overlay hidden">
        <h1 style="font-size: 56px;" data-t="victory">ğŸ† Victory! ğŸ†</h1>
        <p data-t="victoryMsg">All 10 levels completed!<br>You are a true Fruit Master!</p>
        <button id="victory-btn" class="btn" data-t="btnPlayAgain">Play Again</button>
    </div>

    <script>
        // --- Internationalization (i18n) ---
        const translations = {
            en: {
                gameTitle: "ğŸ‰ Fruit Ninja ğŸ¥",
                gameSubtitle: "Challenge Mode",
                tutSlice: "Slice fruits",
                tutBomb: "Bombs hurt",
                tutTime: "Beat the timer",
                readyMsg: "Ready for the challenge?",
                startMsg: "Start from Level 1",
                btnStart: "Start Game",
                scoreLabel: "Score",
                targetLabel: "Target",
                levelCleared: "ğŸ‰ Level Cleared!",
                nextLevel: "Next Level",
                targetScore: "Target Score",
                timeLimit: "Time Limit",
                btnNext: "Next Level",
                gameOver: "Game Over",
                reachedLevel: "You reached",
                levelScore: "Level Score",
                btnTryAgain: "Try Again",
                btnHome: "Home",
                victory: "ğŸ† Victory! ğŸ†",
                victoryMsg: "All 10 levels completed!<br>You are a true Fruit Master!",
                btnPlayAgain: "Play Again",
                levelPrefix: "Level"
            },
            ar: {
                gameTitle: "ğŸ‰ Ù†ÙŠÙ†Ø¬Ø§ Ø§Ù„ÙÙˆØ§ÙƒÙ‡ ğŸ¥",
                gameSubtitle: "ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠ",
                tutSlice: "Ù‚Ø·Ø¹ Ø§Ù„ÙÙˆØ§ÙƒÙ‡",
                tutBomb: "Ø§Ø­Ø°Ø± Ø§Ù„Ù‚Ù†Ø§Ø¨Ù„",
                tutTime: "Ø§Ø³Ø¨Ù‚ Ø§Ù„ÙˆÙ‚Øª",
                readyMsg: "Ù‡Ù„ Ø£Ù†Øª Ù…Ø³ØªØ¹Ø¯ Ù„Ù„ØªØ­Ø¯ÙŠØŸ",
                startMsg: "Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1",
                btnStart: "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©",
                scoreLabel: "Ø§Ù„Ù†Ù‚Ø§Ø·",
                targetLabel: "Ø§Ù„Ù‡Ø¯Ù",
                levelCleared: "ğŸ‰ Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ù…Ø³ØªÙˆÙ‰!",
                nextLevel: "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ",
                targetScore: "Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©",
                timeLimit: "Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯",
                btnNext: "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ",
                gameOver: "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©",
                reachedLevel: "ÙˆØµÙ„Øª Ø¥Ù„Ù‰",
                levelScore: "Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³ØªÙˆÙ‰",
                btnTryAgain: "Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰",
                btnHome: "Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©",
                victory: "ğŸ† Ù†ØµØ±! ğŸ†",
                victoryMsg: "Ø£ÙƒÙ…Ù„Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø¹Ø´Ø±Ø©!<br>Ø£Ù†Øª Ø³ÙŠØ¯ Ø§Ù„ÙÙˆØ§ÙƒÙ‡ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ!",
                btnPlayAgain: "Ø§Ù„Ø¹Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰",
                levelPrefix: "Ù…Ø³ØªÙˆÙ‰"
            }
        };

        // Current Language State
        let currentLang = 'en';

        // --- Game Logic Scope ---
        (function() {
            // Updated Level Config with dual language messages
            const levels = [
                { id: 1,  duration: 45, target: 100, spawnRate: 70, bombChance: 0.0,  
                  msg: { en: "Warm-up: No bombs!", ar: "Ø¥Ø­Ù…Ø§Ø¡: Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ù†Ø§Ø¨Ù„!" } },
                { id: 2,  duration: 45, target: 150, spawnRate: 65, bombChance: 0.05, 
                  msg: { en: "Caution: Bombs ahead!", ar: "ØªØ­Ø°ÙŠØ±: Ø§Ø­Ø°Ø± Ø§Ù„Ù‚Ù†Ø§Ø¨Ù„!" } },
                { id: 3,  duration: 40, target: 200, spawnRate: 60, bombChance: 0.10, 
                  msg: { en: "Speed up: Be quick!", ar: "Ø£Ø³Ø±Ø¹: ÙƒÙ† Ø³Ø±ÙŠØ¹Ø§Ù‹!" } },
                { id: 4,  duration: 40, target: 250, spawnRate: 55, bombChance: 0.15, 
                  msg: { en: "Challenge: Fast hands!", ar: "ØªØ­Ø¯ÙŠ: Ø£ÙŠØ¯ÙŠ Ø³Ø±ÙŠØ¹Ø©!" } },
                { id: 5,  duration: 35, target: 300, spawnRate: 50, bombChance: 0.20, 
                  msg: { en: "Halfway: Stay focused", ar: "Ù…Ù†ØªØµÙ Ø§Ù„Ø·Ø±ÙŠÙ‚: Ø±ÙƒØ² Ø¬ÙŠØ¯Ø§Ù‹" } },
                { id: 6,  duration: 35, target: 350, spawnRate: 45, bombChance: 0.22, 
                  msg: { en: "Chaos: Fruit rain!", ar: "ÙÙˆØ¶Ù‰: Ù…Ø·Ø± Ø§Ù„ÙÙˆØ§ÙƒÙ‡!" } },
                { id: 7,  duration: 30, target: 300, spawnRate: 40, bombChance: 0.25, 
                  msg: { en: "Pressure: Time is tight", ar: "Ø¶ØºØ·: Ø§Ù„ÙˆÙ‚Øª Ø¶ÙŠÙ‚" } },
                { id: 8,  duration: 30, target: 350, spawnRate: 35, bombChance: 0.28, 
                  msg: { en: "Crazy: Bomb crisis", ar: "Ø¬Ù†ÙˆÙ†: Ø£Ø²Ù…Ø© Ù‚Ù†Ø§Ø¨Ù„" } },
                { id: 9,  duration: 25, target: 300, spawnRate: 30, bombChance: 0.30, 
                  msg: { en: "Extreme: Don't blink", ar: "Ù‚ØµÙˆÙ‰: Ù„Ø§ ØªØ±Ù…Ø´" } },
                { id: 10, duration: 25, target: 400, spawnRate: 20, bombChance: 0.35, 
                  msg: { en: "Final Trial: Glory!", ar: "Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: Ø§Ù„Ù…Ø¬Ø¯!" } }
            ];

            const config = {
                gravity: 0.15,
                bladeColor: '#00ffff',
                bladeWidth: 6,
                bladeLife: 8,
                maxLives: 3
            };

            const fruitsData = [
                { emoji: 'ğŸ‰', color: '#ff4d4d', points: 10 },
                { emoji: 'ğŸŠ', color: '#ffa500', points: 10 },
                { emoji: 'ğŸ‹', color: '#ffff00', points: 10 },
                { emoji: 'ğŸ¥', color: '#8ce600', points: 15 },
                { emoji: 'ğŸ¥¥', color: '#e6e6e6', points: 20 },
                { emoji: 'ğŸ', color: '#ff0000', points: 10 },
                { emoji: 'ğŸ‡', color: '#800080', points: 15 }
            ];
            const bombData = { emoji: 'ğŸ’£', color: '#333' };

            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            
            // UI References
            const scoreEl = document.getElementById('score');
            const targetScoreEl = document.getElementById('target-score');
            const livesEl = document.getElementById('lives');
            const timerEl = document.getElementById('timer');
            const levelBadgeEl = document.getElementById('level-badge');

            const menuScreen = document.getElementById('menu-screen');
            const levelClearScreen = document.getElementById('level-clear-screen');
            const gameOverScreen = document.getElementById('game-over-screen');
            const victoryScreen = document.getElementById('victory-screen');
            
            const finalScoreEl = document.getElementById('final-score');
            const finalLevelEl = document.getElementById('final-level');
            const nextLevelNumEl = document.getElementById('next-level-num');
            const nextTargetEl = document.getElementById('next-target');
            const nextTimeEl = document.getElementById('next-time');

            const startBtn = document.getElementById('start-btn');
            const nextLevelBtn = document.getElementById('next-level-btn');
            const restartBtn = document.getElementById('restart-btn');
            const homeBtn = document.getElementById('home-btn');
            const victoryBtn = document.getElementById('victory-btn');

            let width, height;
            let currentLevelIndex = 0; 
            let currentLevelData = null;
            
            let gameRunning = false;
            let isVictory = false; 
            let score = 0;
            let lives = 3;
            let frameCount = 0;
            let timeLeft = 0;
            
            let timerInterval = null;
            let animationId = null;

            let entities = [];
            let particles = [];
            let bladePath = [];

            // --- Language Functions ---
            
            // Global function to set language
            window.setLang = function(lang) {
                currentLang = lang;
                
                // Update HTML direction for RTL support
                document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
                document.documentElement.lang = lang;

                // Update UI Text
                document.querySelectorAll('[data-t]').forEach(el => {
                    const key = el.getAttribute('data-t');
                    if(translations[lang][key]) {
                        el.innerHTML = translations[lang][key];
                    }
                });

                // Update toggle button states
                document.querySelectorAll('.lang-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if(btn.textContent.includes(lang === 'en' ? 'English' : 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©')) {
                        btn.classList.add('active');
                    }
                });

                // Update Level Badge if inside game
                if (currentLevelData) {
                    const prefix = translations[lang].levelPrefix;
                    levelBadgeEl.innerText = `${prefix} ${currentLevelData.id}`;
                }
            };

            function resize() {
                width = canvas.width = window.innerWidth;
                height = canvas.height = window.innerHeight;
            }
            window.addEventListener('resize', resize);
            resize();

            // Initialize language
            window.setLang('en');

            // --- Game Classes ---

            class Point {
                constructor(x, y) { this.x = x; this.y = y; }
            }

            class Particle {
                constructor(x, y, color, speed, size, isText = false, text = '') {
                    this.x = x; this.y = y;
                    const angle = Math.random() * Math.PI * 2;
                    this.vx = Math.cos(angle) * speed;
                    this.vy = Math.sin(angle) * speed;
                    this.color = color;
                    this.alpha = 1;
                    this.decay = Math.random() * 0.02 + 0.015;
                    this.gravity = 0.15;
                    this.size = size;
                    this.isText = isText;
                    this.text = text;
                }
                update() {
                    this.x += this.vx;
                    this.y += this.vy;
                    this.vy += this.gravity;
                    this.alpha -= this.decay;
                }
                draw() {
                    ctx.globalAlpha = Math.max(0, this.alpha);
                    if (this.isText) {
                        ctx.font = `bold ${this.size}px Arial`;
                        ctx.fillStyle = this.color;
                        ctx.fillText(this.text, this.x, this.y);
                    } else {
                        ctx.fillStyle = this.color;
                        ctx.beginPath();
                        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    ctx.globalAlpha = 1;
                }
            }

            class Entity {
                constructor() {
                    this.radius = 35;
                    this.x = Math.random() * (width - 100) + 50; 
                    this.y = height + this.radius;
                    
                    const centerBias = (width / 2 - this.x) * 0.01;
                    this.vx = centerBias + (Math.random() * 4 - 2); 
                    
                    const force = height * 0.024 + Math.random() * 4; 
                    this.vy = -Math.min(force, 28);

                    this.rotation = 0;
                    this.rotationSpeed = (Math.random() - 0.5) * 0.3;
                    this.active = true;
                    this.sliced = false;

                    const isBomb = Math.random() < currentLevelData.bombChance;
                    if (isBomb) {
                        this.type = 'bomb';
                        this.data = bombData;
                    } else {
                        this.type = 'fruit';
                        this.data = fruitsData[Math.floor(Math.random() * fruitsData.length)];
                    }
                }

                update() {
                    this.x += this.vx;
                    this.y += this.vy;
                    this.vy += config.gravity;
                    this.rotation += this.rotationSpeed;

                    if (this.y > height + this.radius + 50) {
                        this.active = false;
                    }
                }

                draw() {
                    ctx.save();
                    ctx.translate(this.x, this.y);
                    ctx.rotate(this.rotation);
                    ctx.font = "60px Segoe UI Emoji";
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";
                    ctx.fillStyle = "#fff";
                    ctx.fillText(this.data.emoji, 0, 5);
                    ctx.restore();
                }

                slice() {
                    if (this.sliced || !this.active) return;
                    this.sliced = true;
                    this.active = false;

                    if (this.type === 'bomb') {
                        createExplosion(this.x, this.y);
                        document.body.classList.add('shake-effect');
                        setTimeout(() => {
                            document.body.classList.remove('shake-effect');
                        }, 500);
                        loseLife();
                    } else {
                        score += this.data.points;
                        updateScoreDisplay();
                        createSliceEffects(this.x, this.y, this.data.color, this.data.emoji);
                        checkLevelWin();
                    }
                }
            }

            // --- Game Flow Functions ---

            function startLevel(levelIndex) {
                currentLevelIndex = levelIndex;
                currentLevelData = levels[currentLevelIndex];
                
                score = 0;
                lives = 3;
                timeLeft = currentLevelData.duration;
                entities = [];
                particles = [];
                bladePath = [];
                frameCount = 0;
                gameRunning = true;
                isVictory = false; 

                // Update Level Badge with translation
                const prefix = translations[currentLang].levelPrefix;
                levelBadgeEl.innerText = `${prefix} ${currentLevelData.id}`;

                updateScoreDisplay();
                updateLivesDisplay();
                updateTimerDisplay();
                
                menuScreen.classList.add('hidden');
                levelClearScreen.classList.add('hidden');
                gameOverScreen.classList.add('hidden');
                victoryScreen.classList.add('hidden');
                document.body.classList.remove('shake-effect');

                if (timerInterval) clearInterval(timerInterval);
                timerInterval = setInterval(tickTimer, 1000);

                if (animationId) cancelAnimationFrame(animationId);
                loop();
            }

            function tickTimer() {
                if (!gameRunning) return;
                timeLeft--;
                updateTimerDisplay();

                if (timeLeft <= 0) {
                    if (score >= currentLevelData.target) {
                        levelComplete();
                    } else {
                        gameOver(false);
                    }
                }
            }

            function checkLevelWin() {
                if (score >= currentLevelData.target) {
                    levelComplete();
                }
            }

            function levelComplete() {
                gameRunning = false;
                clearInterval(timerInterval);
                
                if (currentLevelIndex >= levels.length - 1) {
                    isVictory = true;
                    victoryScreen.classList.remove('hidden');
                } else {
                    const nextLv = levels[currentLevelIndex + 1];
                    nextLevelNumEl.innerText = nextLv.id;
                    nextTargetEl.innerText = nextLv.target;
                    nextTimeEl.innerText = nextLv.duration + 's';
                    levelClearScreen.classList.remove('hidden');
                }
            }

            function gameOver(isBomb) {
                gameRunning = false;
                clearInterval(timerInterval);
                
                const prefix = translations[currentLang].levelPrefix;
                finalLevelEl.innerText = `${prefix} ${currentLevelData.id}`;
                finalScoreEl.innerText = score;
                
                gameOverScreen.classList.remove('hidden');
                
                if (isBomb) {
                    document.body.classList.add('shake-effect');
                    createExplosion(width/2, height/2);
                }
            }

            function loseLife() {
                lives--;
                updateLivesDisplay();
                if (lives <= 0) {
                    gameOver(false);
                }
            }

            function updateScoreDisplay() {
                scoreEl.innerText = score;
                targetScoreEl.innerText = currentLevelData.target;
                if(score >= currentLevelData.target) {
                    scoreEl.style.color = '#4dff4d';
                } else {
                    scoreEl.style.color = '#ffd700';
                }
            }

            function updateLivesDisplay() {
                let hearts = '';
                for(let i=0; i<lives; i++) hearts += 'â¤ï¸';
                for(let i=lives; i<config.maxLives; i++) hearts += 'ğŸ–¤';
                livesEl.innerText = hearts;
            }

            function updateTimerDisplay() {
                timerEl.innerText = timeLeft;
                if (timeLeft <= 10) {
                    timerEl.classList.add('warning');
                } else {
                    timerEl.classList.remove('warning');
                }
            }

            function createSliceEffects(x, y, color, emoji) {
                for (let i = 0; i < 15; i++) {
                    particles.push(new Particle(x, y, color, Math.random() * 5 + 2, Math.random() * 3 + 2));
                }
                let p1 = new Particle(x, y, color, 4, 30, true, emoji);
                p1.vx = -3; p1.vy = -3; p1.rotationSpeed = -0.1;
                particles.push(p1);
                
                let p2 = new Particle(x, y, color, 4, 30, true, emoji);
                p2.vx = 3; p2.vy = -3;
                particles.push(p2);

                particles.push(new Particle(x, y - 30, '#fff', 1, 24, true, '+' + fruitsData.find(f=>f.emoji===emoji).points));
            }

            function createExplosion(x, y) {
                for (let i = 0; i < 50; i++) {
                    particles.push(new Particle(x, y, '#fff', Math.random() * 15, Math.random() * 5 + 2));
                    particles.push(new Particle(x, y, '#ff4444', Math.random() * 10, Math.random() * 4 + 2));
                }
            }
            
            function createFirework(x, y) {
                const colors = ['#ff0044', '#00ff44', '#4400ff', '#ffff00', '#00ffff', '#ff00ff', '#ffffff'];
                const color = colors[Math.floor(Math.random() * colors.length)];
                for (let i = 0; i < 60; i++) {
                    let p = new Particle(x, y, color, Math.random() * 6 + 2, Math.random() * 3 + 1);
                    p.decay = Math.random() * 0.01 + 0.005; 
                    p.gravity = 0.05; 
                    particles.push(p);
                }
            }

            function checkCollisions() {
                if (bladePath.length < 2) return;
                const p1 = bladePath[bladePath.length - 2];
                const p2 = bladePath[bladePath.length - 1];

                entities.forEach(entity => {
                    if (!entity.active || entity.sliced) return;
                    
                    const distSq = (p1.x - entity.x)**2 + (p1.y - entity.y)**2;
                    if (distSq > 10000) return; 

                    const dist1 = Math.hypot(p1.x - entity.x, p1.y - entity.y);
                    const dist2 = Math.hypot(p2.x - entity.x, p2.y - entity.y);
                    
                    if (dist1 < entity.radius || dist2 < entity.radius) {
                        entity.slice();
                    } else {
                       const step = 5;
                       const dx = p2.x - p1.x;
                       const dy = p2.y - p1.y;
                       const len = Math.hypot(dx, dy);
                       for(let i=0; i<=len; i+=step) {
                           const tx = p1.x + (dx/len)*i;
                           const ty = p1.y + (dy/len)*i;
                           if(Math.hypot(tx - entity.x, ty - entity.y) < entity.radius) {
                               entity.slice();
                               break;
                           }
                       }
                    }
                });
            }

            function loop() {
                ctx.clearRect(0, 0, width, height);
                
                // Draw semi-transparent grid
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                ctx.lineWidth = 2;
                ctx.beginPath();
                for(let i=0; i<width; i+=100) { ctx.moveTo(i,0); ctx.lineTo(i,height); }
                for(let i=0; i<height; i+=100) { ctx.moveTo(0,i); ctx.lineTo(width,i); }
                ctx.stroke();
                
                if (isVictory) {
                    if (Math.random() < 0.05) { 
                        createFirework(
                            Math.random() * width,
                            Math.random() * height * 0.6 
                        );
                    }
                }

                if (gameRunning) {
                    frameCount++;
                    if (frameCount % currentLevelData.spawnRate === 0) {
                        let batchSize = 1;
                        if (currentLevelIndex > 2 && Math.random() < 0.4) batchSize = 2;
                        if (currentLevelIndex > 6 && Math.random() < 0.3) batchSize = 3;

                        for(let i=0; i<batchSize; i++) {
                            entities.push(new Entity());
                        }
                    }
                }

                entities = entities.filter(e => e.active);
                entities.forEach(e => {
                    e.update();
                    e.draw();
                });

                particles = particles.filter(p => p.alpha > 0);
                particles.forEach(p => {
                    p.update();
                    p.draw();
                });

                if (bladePath.length > 0) {
                    ctx.beginPath();
                    ctx.moveTo(bladePath[0].x, bladePath[0].y);
                    for (let i = 1; i < bladePath.length; i++) {
                        ctx.lineTo(bladePath[i].x, bladePath[i].y);
                    }
                    ctx.strokeStyle = config.bladeColor;
                    ctx.lineWidth = config.bladeWidth;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = config.bladeColor;
                    ctx.stroke();
                    ctx.shadowBlur = 0;

                    bladePath.shift();
                    if (bladePath.length > config.bladeLife) bladePath.shift();
                }

                animationId = requestAnimationFrame(loop);
            }

            function addPathPoint(x, y) {
                bladePath.push(new Point(x, y));
                if(gameRunning) checkCollisions();
            }
            
            let isMouseDown = false;
            
            window.addEventListener('mousedown', (e) => {
                if (e.target.tagName === 'BUTTON') return;
                isMouseDown = true;
                bladePath = [];
                addPathPoint(e.clientX, e.clientY);
            });
            window.addEventListener('mousemove', (e) => {
                if (isMouseDown) addPathPoint(e.clientX, e.clientY);
            });
            window.addEventListener('mouseup', () => { isMouseDown = false; bladePath = []; });

            window.addEventListener('touchstart', (e) => {
                if (e.target.tagName === 'BUTTON') return;
                for (let i = 0; i < e.changedTouches.length; i++) {
                    bladePath = []; 
                    addPathPoint(e.changedTouches[i].clientX, e.changedTouches[i].clientY);
                }
            }, {passive: false});

            window.addEventListener('touchmove', (e) => {
                e.preventDefault(); 
                for (let i = 0; i < e.changedTouches.length; i++) {
                    addPathPoint(e.changedTouches[i].clientX, e.changedTouches[i].clientY);
                }
            }, {passive: false});
            window.addEventListener('touchend', () => { bladePath = []; });

            // Button Event Listeners
            startBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                startLevel(0); 
            });

            nextLevelBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                startLevel(currentLevelIndex + 1);
            });

            restartBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                startLevel(0); 
            });
            
            // New Home Button Listener
            homeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                // Hide Game Over
                gameOverScreen.classList.add('hidden');
                // Show Main Menu
                menuScreen.classList.remove('hidden');
            });

            victoryBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                startLevel(0);
            });

        })();
    </script>
</body>
</html>